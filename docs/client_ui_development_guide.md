# ECHONET Lite WebSocket クライアント UI 開発ガイド

## 1. はじめに

このガイドは、ECHONET Lite WebSocket プロトコルを使用してクライアントアプリケーションのユーザーインターフェース (UI) を開発する際の詳細な情報とベストプラクティスを提供します。特に、`get_property_description` API を活用して、ECHONET Lite デバイスのプロパティを効果的に表示・操作する方法に焦点を当てます。

## 2. プロパティ情報の取得と活用 (`get_property_description`)

ECHONET Lite デバイスのプロパティ値 (EDT) は、多くの場合、単純なバイト列であり、そのままでは UI で直感的に扱うことが困難です。`get_property_description` API は、特定のデバイスクラス (ClassCode) の各プロパティ (EPC) について、UI フレンドリーな表現方法を定義する情報を提供します。

### 2.1 API の目的

`get_property_description` は、指定された `classCode` に属する各 EPC について、以下の情報を提供することで、UI 実装を簡略化し、統一的なユーザー体験を実現することを目的としています。

- プロパティの人間可読な説明 (`description`)
- プロパティ値のエイリアス (別名) (`aliases`)
- プロパティ値の数値表現に関する詳細 (`numberDesc`)
- プロパティ値の文字列表現に関する詳細 (`stringDesc`)

クライアントは、デバイスの種類 (`classCode`) ごとにこの情報を取得し、キャッシュしておくことで、受信したプロパティ値を解釈したり、ユーザーが値を設定するための適切な UI (選択肢、スライダー、テキスト入力など) を動的に構築したりできます。

### 2.2 応答データの構造と活用

`get_property_description` の応答 (`command_result` の `data` フィールド) に含まれる `properties` オブジェクトの各キー (EPC) に対応する値オブジェクトには、以下のフィールドが含まれる可能性があります。

#### `description` (文字列)

- プロパティの簡単な説明です。UI 上のラベルなどに利用できます。

#### `aliases` (オブジェクト)

- プロパティ値の特定の EDT (Base64 文字列) に対して、人間が理解しやすい名前 (エイリアス) が定義されている場合に存在します。
- キーがエイリアス名 (例: `"on"`, `"auto"`)、値が対応する EDT (Base64 文字列) です。
- **UI での活用:**
  - プロパティ値を受信した際、EDT が `aliases` の値と一致すれば、対応するキー (エイリアス名) を表示します。
  - プロパティ値を設定する際、`aliases` のキーをドロップダウンリストやラジオボタンなどの選択肢としてユーザーに提示し、選択されたエイリアスに対応する EDT をサーバーに送信します。
  - 例: エアコンの運転状態 (EPC `0x80`) で、`aliases` が `{"on": "MzA=", "off": "MzE="}` の場合、受信した EDT が `"MzA="` なら "on" と表示し、設定時には "on" / "off" の選択肢を提供します。

#### `numberDesc` (オブジェクト)

- プロパティ値が数値として解釈・設定できる場合に存在します。数値の範囲や単位を定義します。
- **フィールド:**
  - `min` (数値): 許容される最小値。
  - `max` (数値): 許容される最大値。
  - `offset` (数値): EDT と実際の数値とのオフセット (通常は 0)。
  - `unit` (文字列): 値の単位 (例: `"C"`, `"%"`, `""`)。
  - `edtLen` (数値): この数値を表現するために必要な EDT のバイト長。
- **UI での活用:**
  - プロパティ値を受信した際、`number` フィールドが存在すれば、その数値を表示します。`unit` もあれば併記します。
  - プロパティ値を設定する際、`min` と `max` の範囲を持つスライダーや数値入力フィールドを提供します。ユーザーが入力した数値に対応する EDT を計算してサーバーに送信します (通常は数値を `edtLen` バイトのバイナリに変換し Base64 エンコード)。
  - **注意:** `aliases` と `numberDesc` が共存することもあります。例えば、エアコンの温度設定で、特定の数値範囲 (例: 18-30℃) に加えて、「自動 (auto)」のようなエイリアスが存在する場合があります。UI は両方に対応できるように設計する必要があります (例: スライダーと選択肢の組み合わせ)。また、センサー値などで「測定不能」を示すエイリアス (例: `"N/A"`) が存在する場合もあります。

#### `stringDesc` (オブジェクト)

- プロパティ値が文字列として取得・設定できる場合に存在します。
- **フィールド:**
  - `minEDTLen` (数値): EDT として送信する際の最小バイト長。これより短い文字列の場合は NUL 文字 (`\0`) でパディングされます。UI 実装では通常意識する必要はありません。
  - `maxEDTLen` (数値): EDT として許容される最大バイト長。これは文字列の最大長に対応します。
- **UI での活用:**
  - プロパティ値を受信した際、`string` フィールドが存在すれば、その文字列を表示します。
  - プロパティ値を設定する際、最大 `maxEDTLen` 文字までのテキスト入力フィールドを提供します。入力された文字列を UTF-8 などでエンコードし、Base64 エンコードしてサーバーに送信します。

### 2.3 受信プロパティ値との関連 (`initial_state`, `device_updated`, `property_changed`)

サーバーから送信されるデバイスのプロパティ情報 (`Device` オブジェクト内の `properties` や `property_changed` の `value`) には、`EDT` (Base64) に加えて、`string` や `number` フィールドが含まれることがあります。

```json
// 例: property_changed ペイロード
{
  "ip": "192.168.1.10",
  "eoj": "0130:1",
  "epc": "B3", // Set temperature value
  "value": { "EDT": "MjY=", "string": "26", "number": 26 } // 26
}
```

これらの `string` や `number` の値は、まさに `get_property_description` で定義されたルールに基づいてサーバー側で解釈された結果です。クライアントは、UI 表示のためにこれらの値を直接利用できます。

- `value.number` が存在する場合: `numberDesc` の定義に従って解釈された数値です。
- `value.string` が存在する場合: `aliases` や `stringDesc` の定義に従って解釈された文字列表現です。`numberDesc` がある場合は数値の文字列表現、`aliases` がある場合は一致するエイリアス名、`stringDesc` がある場合はデコードされた文字列、などが考えられます。

### 2.4 キャッシュ戦略

`get_property_description` の応答は、ECHONET Lite の規格バージョンが変わらない限り、通常は不変です。そのため、クライアントは `classCode` ごとに取得した `PropertyDescriptionData` を永続的にキャッシュすることが推奨されます。

1. アプリケーション起動時や、未知の `classCode` を持つデバイスが検出された際に `get_property_description` を呼び出します。
2. 取得した `PropertyDescriptionData` を `classCode` をキーとしてメモリやローカルストレージに保存します。
3. デバイスのプロパティを表示・編集する際には、キャッシュされた `PropertyDescriptionData` を参照して UI を構築・更新します。

これにより、通信量を削減し、UI の応答性を向上させることができます。

## 3. UI 実装パターン例

### 3.1 プロパティ表示

デバイスのプロパティを表示する際は、以下の順序で表示内容を決定します。

1. キャッシュされた `PropertyDescriptionData` から、該当する `classCode` と `epc` の情報を取得します。
2. 受信したプロパティ値 (`value` オブジェクト) を確認します。
3. **エイリアス表示:** `value.EDT` が `aliases` のいずれかの値と一致する場合、対応するエイリアス名 (キー) を表示します。
4. **数値表示:** `value.number` が存在し、`numberDesc` が定義されている場合、`value.number` を表示します。`numberDesc.unit` があれば単位も併記します。
5. **文字列表示:** `value.string` が存在し、`stringDesc` が定義されている場合、`value.string` を表示します。
6. **フォールバック:** 上記のいずれにも当てはまらない場合、`value.string` があればそれを表示するか、`value.EDT` (Base64) をそのまま表示するか、あるいは「不明な値」として表示します。

### 3.2 プロパティ編集

プロパティ編集用の UI コンポーネントは、`PropertyDescriptionData` に基づいて動的に選択します。

1. **エイリアスがある場合:** `aliases` のキーをドロップダウンリスト、ラジオボタン、セグメンテッドコントロールなどの選択肢として提示します。
2. **数値記述がある場合:**
    - `numberDesc.min` と `numberDesc.max` の範囲を持つスライダーや数値入力フィールドを提供します。`numberDesc.unit` を表示します。
    - `aliases` も共存する場合は、選択肢 (エイリアス用) と数値入力/スライダー (数値用) を組み合わせます (例: エアコン温度設定 + 「自動」)。
3. **文字列記述がある場合:** 最大 `stringDesc.maxEDTLen` 文字のテキスト入力フィールドを提供します。
4. **上記以外の場合:** EDT (Base64) を直接入力させるか、編集不可とします。

ユーザーが値を設定したら、`set_properties` API を呼び出してサーバーに送信します。送信する `properties` オブジェクトの値は、プロパティの定義 (`PropertyDescriptionData`) に応じて以下の形式で指定するのが最も簡単です。

- **`aliases` が定義されている場合:** ユーザーが選択したエイリアス名を `{ "string": "エイリアス名" }` で指定します。例えば、`"on"` を選択したら `{ "string": "on" }` とします。サーバー側で対応する EDT に変換されます。(EDT を直接 `{ "EDT": "Base64文字列" }` で指定することも可能ですが、通常は `string` で指定する方が簡単です。)
- **`numberDesc` が定義されている場合:** ユーザーが入力または選択した数値を `{ "number": 数値 }` で指定します。クライアントが EDT を計算する必要はありません。サーバー側で適切な EDT に変換されます。
- **`stringDesc` が定義されている場合 (かつ `aliases` がない場合、またはエイリアス以外の文字列を入力する場合):** ユーザーが入力した文字列を `{ "string": "文字列" }` で指定します。クライアントがエンコードやパディングを行う必要はありません。サーバー側で適切な EDT に変換されます。（`aliases` と `stringDesc` が両方ある場合、サーバーはまずエイリアスとして解釈しようとし、一致しなければ文字列値として扱います。）
- **上記以外、または EDT を直接指定したい場合:** `{ "EDT": "Base64文字列" }` で指定します。

多くの場合、`string` や `number` フィールドを使って値を指定することで、クライアントは EDT の詳細な形式を意識することなくプロパティを設定できます。サーバーはこれらの値を受け取り、`PropertyDescriptionData` に基づいて適切な EDT に変換してデバイスに送信します。
